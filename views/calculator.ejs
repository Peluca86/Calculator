<style>
    @import url('https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@100;600&family=Koulen&family=Roboto:wght@100&display=swap');
    @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css");

    #MainDiv {
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        height: 90vh;
        position: relative;
    }

    #calculator {
        width: 300px;
        border-radius: 5px;
        position: relative;
    }

    /* #historial {
        width: 300px;
        margin-left: 20px;
    } */

    #MainDiv form {
        height: 430px;
        width: 100%;
        background-color: rgb(0, 0, 0);
        border-radius: 5px;
    }

    #MainDiv input[type="text"] {
        height: 25%;
        width: 100%;
        cursor: default;
        font-family: 'Roboto', sans-serif;
        background-color: rgb(0, 0, 0);
        color: white;
        padding: 15px;
        text-align: right;
        border: 0;
        font-size: 50px;
        outline: none;

        margin-top: 5px;
        border-radius: 5px;
        box-sizing: border-box;
    }

    #MainDiv input[type=button],
    input[type=reset] {
        width: 22%;
        cursor: pointer;
        font-family: 'Roboto', sans-serif;
        font-weight: bold;
        font-size: 26px;
        color: black;
        padding: 18px;
        margin: 3px;
        margin-top: 6px;
        border: 0;
        border-radius: 100%;
    }



    #MainDiv .orange {
        background-color: rgb(253, 149, 3) !important;
        color: white !important;
    }

    #MainDiv .gray {
        background-color: rgb(51, 51, 51) !important;
        color: white !important;
    }

    .historial {
        display: none;
        height: 430px;
        width: 300px;
        border: 1px solid black;
        border-radius: 5px;
        overflow: hidden;
        margin-left: 30px;
        background-color: black;
        max-height: 430px;
        overflow-y: auto;
    }

    .historial p {
        font-family: 'Roboto', sans-serif;
        margin-left: 10px;
        color: white;
    }

    .historialBtn {
        position: absolute;
        top: 0;
        right: 0;
        background-color: black;
        border: 0;
        margin: 5px;
        color: white;
    }
</style>


<div id="MainDiv">
    <div id="calculator">
        <form name="calculator">

            <input type="text" name="input" value="" autocomplete="off" readonly>

            <!-- <input type="reset" value="AC" class="orange">
            <input type="button" value="%" onclick="addToInput('%')" class="orange">
            <input type="button" value="/" onclick="addToInput('/')" class="orange">
            <br> -->

            <input type="button" value="7" onclick="addToInput('7')" class="gray">
            <input type="button" value="8" onclick="addToInput('8')" class="gray">
            <input type="button" value="9" onclick="addToInput('9')" class="gray">
            <input type="button" value="X" onclick="addToInput('*')" class="orange">
            <br>
            <input type="button" value="4" onclick="addToInput('4')" class="gray">
            <input type="button" value="5" onclick="addToInput('5')" class="gray">
            <input type="button" value="6" onclick="addToInput('6')" class="gray">
            <input type="button" value="--" onclick="addToInput('-')" class="orange">
            <br>
            <input type="button" value="1" onclick="addToInput('1')" class="gray">
            <input type="button" value="2" onclick="addToInput('2')" class="gray">
            <input type="button" value="3" onclick="addToInput('3')" class="gray">
            <input type="button" value="+" onclick="addToInput('+')" class="orange">
            <br>
            <input type="button" value="0" onclick="addToInput('0')" class="gray">
            <input type="reset" id="reset" value="AC" class="orange">
            <input type="button" value="/" onclick="addToInput('/')" class="orange">
            <input type="button" value="=" onclick="calculate()" class="orange">

        </form>
        <button class="historialBtn" id="historialBtn" onclick="toggleHistorial()"><i
                class="bi bi-clock-history"></i>
        </button>
    </div>
    
    <div id="historial" class="historial">
        <% historial.forEach(function (item) { %>
            <p><%= item.expression %> = <%= item.result %></p>
        <% }) %>
    </div>
</div>



<script>

    function toggleHistorial() {
        var historial = document.getElementById('historial');
        if (historial.style.display === 'none') {
            historial.style.display = 'block';
        } else {
            historial.style.display = 'none';
        }
    }

    var input = document.calculator.input;

    //Mostrar operaciones de la calculadora
    function addToInput(value) {
        var currentValue = input.value;
        var lastChar = currentValue.slice(-1);


        // que no ingrese un operador como primer valor y que no ingrese dos operadores seguidos
        if (currentValue === '' && isOperador(value) || isOperador(lastChar) && isOperador(value)) {
            return;
        }

        input.value += value;
        input.scrollLeft = input.scrollWidth;
        // input.value = input.value + value;

        // Mostrar el historial
        // var historial = JSON.parse(sessionStorage.getItem('historial')) || [];
        // var historialDiv = document.getElementById('historial');
        // historialDiv.innerHTML = '';
        // historial.forEach(function (item) {
        //     historialDiv.innerHTML += '<p>' + item.expression + ' = ' + item.result + '</p>';
        // });
    }

    function isOperador(value) {
        return ['+', '-', '*', '/'].includes(value);
    }

    function calculate() {
        var expression = input.value;

        if (expression === '') {
            return;
        }

        var result = eval(expression);
        input.value = result;

        var historial = JSON.parse(localStorage.getItem('historial')) || [];

        historial.push({ expression, result });

        localStorage.setItem('historial', JSON.stringify(historial));

        // Enviar datos al servidor
        fetch('/guardar-historial', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ historial })
        })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
            })
            .catch(error => {
                console.error(error);
            });
    }



    //numeros y operaciones por teclado

    document.addEventListener('keydown', function (event) {
        var key = event.key;

        var isNum = /^\d$/.test(key);
        var isOperacion = /^[\+\-\*\/]$/.test(key);

        if (isNum || isOperacion) {
            addToInput(key);
            event.preventDefault();
        }
    });

</script>